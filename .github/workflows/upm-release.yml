name: Auto UPM Release

on:
  push:
    branches:
      - main
    paths:
      - 'Assets/Deepwave/WaveCore/**'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Config Git Bot
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Split and Push UPM Branch
        run: |
          git subtree split --prefix="Assets/Deepwave/WaveCore" -b upm
          git push -f origin upm:upm

      - name: Export Unity Package
        uses: pCYSlv8n/UnityPackageExporter@v1
        with:
          package_name: 'TempPackage'
          include_files: 'Assets/Deepwave/WaveCore'

      - name: Create Tag and GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PATH_JSON="Assets/Deepwave/WaveCore/package.json"
          VERSION=$(jq -r .version $PATH_JSON)
          PACKAGE_ID=$(jq -r .name $PATH_JSON)
          TAG="v$VERSION"
          
          FINAL_PACKAGE_NAME="${PACKAGE_ID}_v${VERSION}.unitypackage"
          mv TempPackage.unitypackage "$FINAL_PACKAGE_NAME"
          
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "Tag $TAG đã tồn tại. Bỏ qua."
            exit 0
          fi
          
          git tag $TAG upm
          git push origin $TAG

          # --- LOGIC LỌC VÀ ĐỊNH DẠNG CHANGELOG ---
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $TAG^ 2>/dev/null || echo "")
          RANGE=$([ -z "$PREVIOUS_TAG" ] && echo "main" || echo "$PREVIOUS_TAG..main")

          # Hàm để lọc và làm đẹp nội dung
          format_log() {
            local prefix=$1
            local title=$2
            # Lấy log -> lọc theo prefix -> xóa prefix và dấu : -> in ra list
            local logs=$(git log $RANGE --pretty=format:"* %s (%h)" -- Assets/Deepwave/WaveCore | \
                         grep -iE "^\* $prefix:" | \
                         sed -E "s/^\* $prefix:[[:space:]]*/- /I")
            
            if [ ! -z "$logs" ]; then
              echo -e "### $title\n$logs\n"
            fi
          }

          # Xây dựng nội dung CHANGELOG theo từng mục
          BODY=""
          BODY+="$(format_log "feat" "Features")"
          BODY+="$(format_log "update" "Updates")"
          BODY+="$(format_log "fix" "Bug Fixes")"
          BODY+="$(format_log "clear" "Clean Up")"
          BODY+="$(format_log "refactor" "Refactors")"
          BODY+="$(format_log "perf" "Performance")"
          BODY+="$(format_log "docs" "Documentation")"
          BODY+="$(format_log "chore" "Maintenance")"

          if [ -z "$BODY" ]; then
            BODY="* No significant changes listed."
          fi

          echo "--- Changelog Preview ---"
          echo -e "$BODY"

          # Tạo Release
          printf "## What's Changed trong $PACKAGE_ID\n\n$BODY" | gh release create $TAG "$FINAL_PACKAGE_NAME" \
            --title "WaveCore $TAG" \
            --notes-file - \
            --target upm