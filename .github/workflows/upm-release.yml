name: Auto UPM Release

on:
  push:
    branches:
      - main
    paths:
      - 'Assets/Deepwave/WaveCore/**'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Config Git Bot
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Split and Push UPM Branch
        run: |
          git subtree split --prefix="Assets/Deepwave/WaveCore" -b upm
          git push -f origin upm:upm

      # Tự động đóng gói .unitypackage không cần dùng Action bên thứ 3
      - name: Export Unity Package Natively
        run: |
          PACKAGE_DIR="Assets/Deepwave/WaveCore"
          TEMP_DIR="temp_package"
          mkdir -p $TEMP_DIR
          
          # Quét tất cả file .meta để tái tạo cấu trúc thư mục guid
          find "$PACKAGE_DIR" -name "*.meta" | while read -r meta_file; do
            asset_file="${meta_file%.meta}" # Đường dẫn file gốc
            guid=$(grep "^guid:" "$meta_file" | awk '{print $2}' | tr -d '\r')
            
            if [ -n "$guid" ]; then
              mkdir -p "$TEMP_DIR/$guid"
              cp "$meta_file" "$TEMP_DIR/$guid/asset.meta"
              echo "$asset_file" > "$TEMP_DIR/$guid/pathname"
              
              # Nếu là file (không phải thư mục), copy nội dung asset vào
              if [ -f "$asset_file" ]; then
                cp "$asset_file" "$TEMP_DIR/$guid/asset"
              fi
            fi
          done
          
          # Nén thành định dạng .unitypackage (thực chất là tar.gz)
          cd $TEMP_DIR
          tar -zcf ../TempPackage.unitypackage *
          cd ..
          rm -rf $TEMP_DIR

      - name: Create Tag and GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PATH_JSON="Assets/Deepwave/WaveCore/package.json"
          VERSION=$(jq -r .version $PATH_JSON)
          PACKAGE_ID=$(jq -r .name $PATH_JSON)
          TAG="v$VERSION"
          
          FINAL_PACKAGE_NAME="${PACKAGE_ID}_v${VERSION}.unitypackage"
          mv TempPackage.unitypackage "$FINAL_PACKAGE_NAME"
          
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            echo "Tag $TAG đã tồn tại. Bỏ qua."
            exit 0
          fi
          
          git tag $TAG upm
          git push origin $TAG

          # --- LOGIC LỌC VÀ ĐỊNH DẠNG CHANGELOG ---
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $TAG^ 2>/dev/null || echo "")
          RANGE=$([ -z "$PREVIOUS_TAG" ] && echo "main" || echo "$PREVIOUS_TAG..main")

          format_log() {
            local prefix=$1
            local title=$2
            local logs=$(git log $RANGE --pretty=format:"* %s (%h)" -- Assets/Deepwave/WaveCore | \
                         grep -iE "^\* $prefix:" | \
                         sed -E "s/^\* $prefix:[[:space:]]*/- /I")
            
            if [ ! -z "$logs" ]; then
              echo -e "### $title\n$logs\n"
            fi
          }

          BODY=""
          BODY+="$(format_log "feat" "Features")"
          BODY+="$(format_log "update" "Updates")"
          BODY+="$(format_log "fix" "Bug Fixes")"
          BODY+="$(format_log "clear" "Clean Up")"
          BODY+="$(format_log "refactor" "Refactors")"
          BODY+="$(format_log "perf" "Performance")"
          BODY+="$(format_log "docs" "Documentation")"
          BODY+="$(format_log "chore" "Maintenance")"

          if [ -z "$BODY" ]; then
            BODY="* No significant changes listed."
          fi

          echo "--- Changelog Preview ---"
          echo -e "$BODY"

          # Tạo Release
          printf "## What's Changed trong $PACKAGE_ID\n\n$BODY" | gh release create $TAG "$FINAL_PACKAGE_NAME" \
            --title "WaveCore $TAG" \
            --notes-file - \
            --target upm